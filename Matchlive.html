<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TV Debug — 2 chaînes</title>
  <style>
    body{margin:0;height:100vh;display:flex;font-family:Arial,Helvetica;background:#000;color:#fff}
    .menu{width:220px;background:#111;padding:12px;box-sizing:border-box}
    .chan{padding:10px;margin-bottom:8px;background:#1b1b1b;border-radius:6px;cursor:pointer;text-align:center}
    .chan.active{border:2px solid #e50914}
    .player{flex:1;position:relative;display:flex;flex-direction:column}
    #video{width:100%;height:100%;background:#000;object-fit:contain}
    .status{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.6);padding:8px;border-radius:6px;border:1px solid #333;font-size:13px}
    .error{color:#ff6b6b}
    .info{color:#9aa0a6}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
  <div class="menu">
    <div class="chan" id="b0" onclick="play(0)">Chaîne 1</div>
    <div class="chan" id="b1" onclick="play(1)">Chaîne 2</div>
    <hr style="border:0;border-top:1px solid #222;margin:12px 0">
    <div style="font-size:13px;color:#9aa0a6">Tests / debugging</div>
    <div id="manifestLink" style="margin-top:8px;word-break:break-all"></div>
  </div>

  <div class="player">
    <video id="video" controls autoplay muted></video>
    <div class="status" id="status">Prêt</div>
  </div>

<script>
const channels = [
  "http://bk.xiptv.network:80/live/freelist/freelist568/11536.m3u8",
  "http://bk.xiptv.network:80/live/freelist/freelist568/11619.m3u8"
];

const video = document.getElementById('video');
const status = document.getElementById('status');

function setStatus(txt, isError=false){
  status.textContent = txt;
  status.className = isError ? 'status error' : 'status';
}

function showManifestLink(url){
  const el = document.getElementById('manifestLink');
  el.innerHTML = '<div style="font-size:13px;color:#9aa0a6">Ouvrir manifest:</div><a href="'+url+'" target="_blank" style="color:#9ee1a8">'+url+'</a>';
}

// Try to fetch the manifest first to get clearer errors (CORS / 404 etc)
async function testManifest(url){
  try{
    setStatus('Vérification du manifest…');
    const resp = await fetch(url, { method: 'GET', mode: 'cors' });
    const text = await resp.text();
    if(!resp.ok){
      setStatus('Erreur HTTP '+resp.status+' — '+resp.statusText, true);
      console.error('HTTP error', resp.status, resp.statusText);
      return { ok:false, status:resp.status, text };
    }
    if(text && text.includes('#EXTM3U')){
      setStatus('Manifest reçu — tentative de lecture');
      return { ok:true, text };
    } else {
      setStatus('Réponse reçue, mais pas de manifest HLS (#EXTM3U)', true);
      return { ok:false, text };
    }
  }catch(err){
    // Typical CORS error will appear here as TypeError: Failed to fetch
    setStatus('Erreur réseau / CORS — regarde la console (F12) pour détails', true);
    console.error('Fetch error', err);
    return { ok:false, err };
  }
}

let hls = null;
async function play(index){
  document.querySelectorAll('.chan').forEach((el,i)=>el.classList.toggle('active', i===index));
  const url = channels[index];
  showManifestLink(url);
  const check = await testManifest(url);
  if(!check.ok) return; // stop: we need manifest accessible

  // destroy previous hls instance
  if(hls){ try{ hls.destroy(); } catch(e){} hls = null; }

  if(Hls.isSupported()){
    hls = new Hls({maxBufferLength:30});
    hls.loadSource(url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => { video.play().catch(()=>{}); setStatus('Lecture en cours'); });
    hls.on(Hls.Events.ERROR, (event, data) => {
      console.error('HLS error', event, data);
      setStatus('Erreur HLS — voir console', true);
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')){
    video.src = url;
    video.play().catch(()=>{ setStatus('Lecture bloquée (autoplay) — action requise', true); });
    setStatus('Lecture en cours (natif)');
  } else {
    setStatus('Navigateur ne supporte pas HLS', true);
  }
}

// start first channel
play(0);
</script>
</body>
</html>
